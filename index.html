<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeEmJe LinkSpace</title>

    <meta name="title" content="PeEmJe Link Space" />
    <meta
      name="description"
      content="PeEmJe LinkSpace: Hub digital terpadu untuk mengorganisasi setiap koneksi penting dalam hidup Anda. Lebih dari sekadar kumpulan link, ini adalah ruang pribadi yang dinamis untuk menyatukan semua yang Anda butuhkan‚Äîdari materi manajemen sekolah hingga referensi pribadi‚Äîdalam satu tempat yang rapi dan mudah diakses." />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://pmj-linkspace.vercel.app/" />
    <meta property="og:title" content="PeEmJe LinkSpace" />
    <meta
      property="og:description"
      content="PeEmJe LinkSpace: Hub digital terpadu untuk mengorganisasi setiap koneksi penting dalam hidup Anda. Lebih dari sekadar kumpulan link, ini adalah ruang pribadi yang dinamis untuk menyatukan semua yang Anda butuhkan‚Äîdari materi manajemen sekolah hingga referensi pribadi‚Äîdalam satu tempat yang rapi dan mudah diakses." />
    <meta
      property="og:image"
      content="https://pmj-linkspace.vercel.app/assets/apple-icon-144x144.png" />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://pmj-linkspace.vercel.app/" />
    <meta property="twitter:title" content="PeEmJe LinkSpace" />
    <meta
      property="twitter:description"
      content="PeEmJe LinkSpace: Hub digital terpadu untuk mengorganisasi setiap koneksi penting dalam hidup Anda. Lebih dari sekadar kumpulan link, ini adalah ruang pribadi yang dinamis untuk menyatukan semua yang Anda butuhkan‚Äîdari materi manajemen sekolah hingga referensi pribadi‚Äîdalam satu tempat yang rapi dan mudah diakses." />
    <meta
      property="twitter:image"
      content="https://pmj-linkspace.vercel.app/assets/apple-icon-144x144.png" />

    <meta name="theme-color" content="#0f172a" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png" />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png" />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png" />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png" />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png" />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png" />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png" />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png" />

    <link
      rel="icon"
      type="image/png"
      sizes="144x144"
      href="/assets/android-icon-144x144.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

    <style>
      :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --danger-color: #ef4444;
        --danger-hover: #dc2626;
        --warning-color: #f59e0b;
        --warning-hover: #d97706;
        --success-color: #22c55e;
        --info-color: #3b82f6;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
      }

      html[data-theme="dark"] {
        --background-color: #0f172a;
        --card-background: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border-color: #334155;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary);
        line-height: 1.6;
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      /* --- Auth Page --- */
      .auth-container {
        background: var(--card-background);
        border-radius: 12px;
        padding: 40px;
        max-width: 400px;
        margin: 100px auto;
        border: 1px solid var(--border-color);
        text-align: center;
      }

      .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1px;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .logo img {
        height: 60px;
      }

      /* Styles for the login page logo specifically */
      .auth-logo {
        flex-direction: column; /* Stack items vertically */
        gap: 16px; /* Adjust gap for vertical stacking */
        margin-bottom: 12px;
      }

      .auth-logo img {
        height: 170px; /* Make logo bigger */
      }

      .auth-container p {
        color: var(--text-secondary);
        margin-bottom: 32px;
      }

      /* --- Main App --- */
      .main-container {
        background: transparent;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align items to the top */
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header .logo {
        font-size: 1.5rem;
        justify-content: flex-start; /* Align header logo to the left */
      }

      .header .logo img {
        height: 60px;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .user-info {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .user-details {
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 0;
        line-height: 1.4;
      }

      #userRoleOrTags {
        margin-top: 4px;
      }

      .user-info span#userName {
        font-weight: 600;
        font-size: 15px;
      }

      .user-info span#userEmail {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      /* --- Buttons --- */
      .btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .btn:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .btn-icon {
        padding: 10px;
        width: 40px;
        height: 40px;
      }

      .btn-secondary {
        background-color: var(--card-background);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .btn-secondary:hover {
        background-color: #f1f5f9;
      }
      html[data-theme="dark"] .btn-secondary:hover {
        background-color: #334155;
      }

      .btn-danger {
        background-color: var(--danger-color);
      }
      .btn-danger:hover {
        background-color: var(--danger-hover);
      }
      .btn-warning {
        background-color: var(--warning-color);
      }
      .btn-warning:hover {
        background-color: var(--warning-hover);
      }
      .btn-info {
        background-color: var(--info-color);
      }
      .btn-success {
        background-color: var(--success-color);
      }

      /* --- Forms & Search --- */
      .form-section,
      .link-card,
      .admin-section,
      .modal-content,
      .auth-container,
      .tutorial-card {
        transition: background-color 0.3s, border-color 0.3s;
      }

      .form-section {
        background: var(--card-background);
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 32px;
        border: 1px solid var(--border-color);
      }

      .form-section h3 {
        font-size: 1.25rem;
        margin-bottom: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 6px 14px;
        border: 1px solid var(--border-color);
        border-radius: 9px;
        font-size: 13px;
        outline: none;
        transition: all 0.2s ease;
        background-color: var(--background-color);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
      }

      .form-select.folder {
        width: 100%;
        padding: 9px 14px;
        border: 1px solid var(--border-color);
        border-radius: 99px;
        font-size: 13px;
        outline: none;
        transition: all 0.2s ease;
        background-color: var(--background-color);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
      }

      .form-select,
      .form-select.folder {
        appearance: none; /* Sembunyikan panah bawaan */
        -webkit-appearance: none;

        /* Tambahkan panah custom menggunakan SVG */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem; /* Beri ruang di kanan untuk panah baru */
      }

      .form-input:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .privacy-options {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }
      .privacy-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-container {
        position: relative;
        margin-bottom: 16px;
      }
      .search-input {
        width: 100%;
        padding: 12px 16px 12px 40px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
      }
      .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
      }

      /* --- Link Card --- */
      .link-card {
        background: var(--card-background);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .link-card.selected {
        border-color: var(--primary-color);
        background-color: #f0f2ff;
      }
      html[data-theme="dark"] .link-card.selected {
        background-color: #2a3a5a;
      }

      .link-card-main {
        flex-grow: 1;
        overflow: hidden;
      }
      .link-card-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }

      .pin-btn {
        cursor: pointer;
        font-size: 20px;
        color: var(--text-secondary);
        transition: color 0.2s, transform 0.2s;
      }
      .pin-btn.pinned {
        color: var(--warning-color);
        transform: rotate(45deg);
      }

      .link-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
      }

      .link-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .link-author-date {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
      }
      .link-url {
        color: var(--primary-color);
        text-decoration: none;
        margin-bottom: 12px;
        display: block;
        word-break: break-all;
        font-size: 14px;
      }
      .link-url:hover {
        text-decoration: underline;
      }
      .link-card p {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }

      .link-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--text-secondary);
        flex-wrap: wrap;
        gap: 10px;
      }
      .link-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .link-actions-card {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .badges-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }
      .privacy-badge,
      .tag-badge {
        padding: 3px 10px;
        border-radius: 99px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .privacy-public {
        background-color: #ecfdf5;
        color: #166534;
      }
      .privacy-private {
        background-color: #feefee;
        color: #b91c1c;
      }
      .tag-badge {
        background-color: #eef2ff;
        color: #4338ca;
      }

      html[data-theme="dark"] .privacy-public {
        background-color: #052e16;
        color: #bbf7d0;
      }
      html[data-theme="dark"] .privacy-private {
        background-color: #450a0a;
        color: #fecaca;
      }
      html[data-theme="dark"] .tag-badge {
        background-color: #312e81;
        color: #e0e7ff;
      }

      /* --- Admin Section --- */
      .admin-section {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
      }
      .admin-title {
        font-size: 1.5rem;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
      }
      .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto; /* Izinkan scroll horizontal */
        flex-wrap: nowrap; /* Mencegah tab turun ke bawah */
        -ms-overflow-style: none; /* Sembunyikan scrollbar di IE dan Edge */
        scrollbar-width: none; /* Sembunyikan scrollbar di Firefox */
      }

      /* Sembunyikan scrollbar di Chrome, Safari, dan Opera */
      .admin-tabs::-webkit-scrollbar {
        display: none;
      }

      .truncate-text {
        white-space: nowrap; /* Mencegah teks turun ke baris baru */
        overflow: hidden; /* Sembunyikan teks yang meluap */
        text-overflow: ellipsis; /* Tampilkan "..." di akhir */
        margin-right: 160px; /* Beri jarak kanan agar tidak terlalu mepet */
      }
      .tab-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        white-space: nowrap;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .chart-container {
        max-width: 300px;
        margin: 20px auto;
      }

      .user-list-item {
        background: var(--background-color);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
      }
      .user-list-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-list-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }

      .tab-badge {
        background-color: var(--primary-color);
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 7px;
        border-radius: 10px;
        margin-left: 8px;
        display: none; /* Hidden by default */
      }

      .tab-badge.visible {
        display: inline-block; /* Shown when it has a count */
      }

      #pendingUsers,
      #allUsers,
      #folderList {
        max-height: 40vh;
        overflow-y: auto;
        padding-right: 10px;
        margin-right: -10px; /* Counteract padding */
      }

      #pendingUsers::-webkit-scrollbar,
      #allUsers::-webkit-scrollbar,
      #folderList::-webkit-scrollbar {
        width: 8px;
      }
      #pendingUsers::-webkit-scrollbar-track,
      #allUsers::-webkit-scrollbar-track,
      #folderList::-webkit-scrollbar-track {
        background: transparent;
      }
      #pendingUsers::-webkit-scrollbar-thumb,
      #allUsers::-webkit-scrollbar-thumb,
      #folderList::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 8px;
      }
      #pendingUsers::-webkit-scrollbar-thumb:hover,
      #allUsers::-webkit-scrollbar-thumb:hover,
      #folderList::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      #foldersContent .user-list-item {
        flex-direction: row; /* Paksa tetap horizontal */
        align-items: center; /* Sejajarkan item secara vertikal */
      }

      #foldersContent .user-list-item button {
        flex-shrink: 0; /* Mencegah tombol menyusut jika nama folder panjang */
        margin-left: 16px; /* Beri sedikit jarak */
      }

      /* --- Modal --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.5);
        z-index: 1000;
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: var(--card-background);
        border-radius: 16px;
        padding: 32px;
        max-width: 440px;
        width: 90%;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      .modal-content .modal-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }
      .modal-close {
        position: absolute;
        right: 12px;
        top: 12px;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        width: 32px;
        height: 32px;
        line-height: 32px;
      }

      .hidden {
        display: none;
      }

      /* --- Loading Spinner --- */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* --- Link Container & Bulk Actions --- */
      #linksSection {
        padding-bottom: 80px; /* Space for bulk action bar */
        max-height: 65vh; /* Batasi tinggi kontainer link */
        overflow-y: auto; /* Tambahkan scrollbar vertikal jika konten meluap */
        padding-right: 10px; /* Beri sedikit ruang untuk scrollbar */
      }
      #linksContainer {
        min-height: 200px;
      }
      #pinnedLinksContainer,
      #regularLinksContainer {
        margin-top: 16px;
      }
      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }

      #bulkActionBar {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        max-width: 90%;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        z-index: 99;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: bottom 0.3s ease-in-out;

        flex-wrap: wrap; /* Izinkan item turun ke baris baru */
        justify-content: center;
      }
      #bulkActionBar.visible {
        bottom: 20px;
      }

      #bulkActionBar .btn-icon {
        width: 40px;
        height: 40px;
        padding: 8px; /* Atur padding agar ikon pas */
      }

      /* --- Filters & Tags --- */
      #filterContainer {
        margin-bottom: 24px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px; /* Beri jarak antar grup */
        justify-content: space-between; /* Kunci utama: mendorong grup ke ujung */
      }

      /* Wadah baru untuk grup filter di sisi kiri */
      .filter-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
      }
      .filter-btn {
        background-color: var(--card-background);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 6px 14px;
        border-radius: 99px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin: 0;
      }
      .filter-btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      #currentTags .tag-item {
        display: inline-flex;
        align-items: center;
        background: #eef2ff;
        color: #4338ca;
        padding: 4px 8px;
        border-radius: 6px;
        margin: 2px;
      }
      #currentTags .tag-remove {
        margin-left: 6px;
        cursor: pointer;
        font-weight: bold;
      }

      /* --- Tutorial Card --- */
      .tutorial-card {
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        color: #4338ca;
        border-radius: 12px;
        padding: 24px;
        margin: -16px 0 32px 0;
        position: relative;
      }

      html[data-theme="dark"] .tutorial-card {
        background: #1e293b;
        border-color: #312e81;
        color: #c7d2fe;
      }
      .tutorial-card h4 {
        margin-bottom: 12px;
      }
      .tutorial-card ul {
        list-style-position: inside;
        padding-left: 0;
      }
      .tutorial-card li {
        margin-bottom: 6px;
        font-size: 14px;
      }
      .close-tutorial {
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 24px;
        cursor: pointer;
        color: #6366f1;
      }

      /* Dark Mode FAB */
      .fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        z-index: 100;
        transition: all 0.3s ease;
        user-select: none;
      }

      .fab:hover {
        transform: scale(1.1);
        background-color: var(--background-color);
      }

      .fab span {
        transition: opacity 0.3s;
      }

      .link-actions-card .btn {
        /* Reset dan paksa ukuran yang kita inginkan */
        /* width: 32px !important; */
        height: 32px !important;
        padding: 6px !important; /* Paling penting: Timpa padding dari .btn */

        /* Pastikan ikon di tengah */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .link-actions-card .btn svg {
        width: 100%;
        height: 100%;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px 15px;
        }
        .auth-container {
          margin-top: 50px;
          padding: 30px;
        }
        .header {
          flex-direction: column;
          align-items: center;
          gap: 24px;
        }
        .header-controls {
          flex-direction: column;
          align-items: center;
          gap: 16px;
        }
        .user-info {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }
        .user-details {
          text-align: center;
        }
        #userRoleOrTags.badges-container {
          justify-content: center;
        }

        .link-meta {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .link-actions {
          width: 100%;
          justify-content: flex-start;
        }
        .user-list-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
        .modal-content {
          width: calc(100% - 30px);
        }
      }

      /* --- CSS BARU UNTUK MODE SELEKSI --- */

      /* 1. Sembunyikan checkbox secara default */
      .link-card .link-checkbox {
        transform: scale(0); /* Sembunyikan dengan animasi scale */
        transition: transform 0.2s ease;
      }

      /* 2. Saat body memiliki kelas 'selection-mode', tampilkan checkbox */
      body.selection-mode .link-card .link-checkbox {
        transform: scale(1); /* Tampilkan dengan animasi scale */
      }

      /* 3. Atur agar checkbox menjadi bulat */
      .link-checkbox {
        appearance: none;
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 50%; /* Membuatnya bulat */
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        margin-top: 4px;
      }
      .link-checkbox:checked {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
      }

      /* 4. Buat tanda centang di dalam bulatan */
      /* 4. Buat tanda centang di dalam bulatan (VERSI DIPERBAIKI) */
      .link-checkbox:checked::after {
        content: "";
        position: absolute;
        /* Sesuaikan nilai top & left untuk centering */
        top: -6px;
        left: 6px;
        /* Perbesar ukuran centang */
        width: 6px;
        height: 17px;
        border: solid rgb(79, 235, 48);
        border-width: 0 4px 4px 0; /* Dibuat sedikit lebih tebal */
        transform: rotate(45deg);
      }
    </style>
  </head>
  <body>
    <div id="authContainer" class="container">
      <div class="auth-container">
        <div class="logo auth-logo">
          <img src="/assets/icon.png" alt="PeEmJe LinkSpace Logo" />
          <span>PeEmJe LinkSpace</span>
        </div>
        <p>Kelola semua link penting Anda di satu tempat.</p>
        <button id="loginBtn" class="btn" style="width: 100%">
          üöÄ Masuk dengan Google
        </button>
        <div
          id="authStatus"
          style="
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 16px;
          "></div>
        <p
          style="
            margin-top: 32px;
            font-size: 12px;
            color: var(--text-secondary);
          ">
          diorganisir oleh Muhammad Rival
        </p>
      </div>
    </div>

    <div id="mainContainer" class="container hidden">
      <div class="header">
        <div class="logo">
          <img src="/assets/icon.png" alt="PeEmJe LinkSpace Logo" />
          <span>PeEmJe LinkSpace</span>
        </div>
        <div class="header-controls">
          <div class="user-info">
            <img id="userAvatar" class="user-avatar" src="" alt="Avatar" />
            <div class="user-details">
              <span id="userName"></span>
              <span
                id="userEmail"
                style="font-size: 13px; color: var(--text-secondary)"></span>
              <div id="userRoleOrTags" class="badges-container"></div>
            </div>
          </div>
          <button
            id="logoutBtn"
            class="btn btn-secondary btn-icon"
            title="Keluar">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>

      <div id="tutorialCard" class="tutorial-card">
        <span id="closeTutorialBtn" class="close-tutorial">&times;</span>
        <h4>üëã Selamat Datang di PeEmJe LinkSpace!</h4>
        <ul>
          <li>
            <strong>Tambah Link:</strong> Gunakan form "Tambah Link Baru" untuk
            menyimpan URL penting Anda.
          </li>
          <li>
            <strong>Filter Canggih:</strong> Klik tombol filter di atas daftar
            untuk menyortir link berdasarkan kategori.
          </li>
          <li>
            <strong>Admin:</strong> Jika Anda adalah admin, Anda dapat mengelola
            pengguna dan memberikan tag melalui Dasbor Admin.
          </li>
        </ul>
      </div>

      <div
        id="userLinkStats"
        class="form-section hidden"
        style="margin-bottom: 24px"></div>

      <div id="adminSection" class="admin-section hidden">
        <div class="admin-title">üëë Dasbor Admin</div>
        <div class="admin-tabs">
          <button class="tab-btn active" data-tab="stats">Statistik</button>
          <button class="tab-btn" data-tab="pending">
            Persetujuan <span id="pendingCountBadge" class="tab-badge"></span>
          </button>
          <button class="tab-btn" data-tab="users">
            Kelola Pengguna <span id="totalUsersBadge" class="tab-badge"></span>
          </button>
          <button class="tab-btn" data-tab="blocked">
            Daftar Blokir <span id="blockedCountBadge" class="tab-badge"></span>
          </button>
          <button class="tab-btn" data-tab="folders">
            Kelola Folder <span id="totalFoldersBadge" class="tab-badge"></span>
          </button>
        </div>

        <div id="statsContent" class="tab-content active">
          <h3>Statistik Pengguna</h3>
          <div class="chart-container">
            <canvas id="userStatsChart"></canvas>
          </div>
          <hr
            style="
              border: none;
              border-top: 1px solid var(--border-color);
              margin: 32px 0;
            " />
          <h3>Statistik Link</h3>
          <div id="linkStatsContainer" style="margin-top: 20px"></div>
        </div>
        <div id="pendingContent" class="tab-content">
          <h3>Menunggu Persetujuan</h3>
          <div id="pendingUsers"></div>
        </div>
        <div id="usersContent" class="tab-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 16px;
            ">
            <h3>Semua Pengguna</h3>
            <button id="exportActiveBtn" class="btn btn-secondary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export CSV
            </button>
          </div>
          <div class="search-container" style="margin-bottom: 16px">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              id="userSearchInput"
              class="search-input"
              placeholder="Cari berdasarkan nama atau email..." />
          </div>
          <div id="allUsers"></div>
        </div>
        <div id="blockedContent" class="tab-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 16px;
            ">
            <h3>Pengguna Diblokir</h3>
            <button id="exportBlockedBtn" class="btn btn-secondary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export CSV
            </button>
          </div>
          <div id="blockedUsersList"></div>
        </div>
        <div id="foldersContent" class="tab-content">
          <h3>Manajemen Folder</h3>
          <form id="addFolderForm" class="form-group">
            <label for="newFolderInput" class="form-label"
              >Buat Folder Baru</label
            >
            <div style="display: flex; gap: 8px">
              <input
                type="text"
                id="newFolderInput"
                class="form-input"
                placeholder="Nama Folder"
                required />
              <button type="submit" class="btn">Buat</button>
            </div>
          </form>
          <div id="folderList"></div>
        </div>
      </div>

      <button
        id="showAddLinkBtn"
        class="btn"
        style="
          width: 100%;
          margin-bottom: 24px;
          font-size: 1rem;
          padding: 12px;
        ">
        ‚ûï Tambah Link Baru
      </button>

      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Cari berdasarkan judul, url, atau deskripsi..." />
      </div>

      <div id="filterContainer"></div>

      <div id="linksSection">
        <div id="pinnedLinksContainer"></div>
        <div id="regularLinksContainer"></div>
        <div id="linksContainerPlaceholder" class="hidden">
          <div class="loading">
            <div class="spinner"></div>
            <span>Memuat link...</span>
          </div>
        </div>
      </div>
    </div>

    <div id="bulkActionBar">
      <span id="selectionCount"></span>
      <select
        id="bulkMoveFolderSelect"
        class="form-select"
        style="width: 150px"></select>

      <button
        id="bulkMoveBtn"
        class="btn btn-info btn-icon"
        title="Pindahkan Link">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M2 7.5l4 0"></path>
          <path d="M2 12.5l4 0"></path>
          <path d="M2 17.5l4 0"></path>
          <path d="M12 4v16"></path>
          <path d="M8 8l4-4l4 4"></path>
          <rect x="8" y="4" width="12" height="16" rx="2"></rect>
        </svg>
      </button>

      <button
        id="bulkDeleteBtn"
        class="btn btn-danger btn-icon"
        title="Hapus Link">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path
            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>
    </div>

    <div id="addLinkModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" id="addModalClose">&times;</span>
        <h3 style="margin-bottom: 20px; text-align: left">
          ‚ûï Tambah Link Baru
        </h3>
        <form id="addLinkForm" style="text-align: left">
          <div class="form-group">
            <label class="form-label" for="linkTitle">Judul Link</label>
            <input
              type="text"
              id="linkTitle"
              class="form-input"
              placeholder="Contoh: Portofolio Desain"
              required />
          </div>
          <div class="form-group">
            <label class="form-label" for="linkUrl">URL</label>
            <input
              type="url"
              id="linkUrl"
              class="form-input"
              placeholder="https://example.com"
              required />
          </div>
          <div class="form-group">
            <label class="form-label" for="linkFolder">Folder (Opsional)</label>
            <select id="linkFolder" class="form-select">
              <option value="">Tidak ada folder</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="linkDescription"
              >Deskripsi (Opsional)</label
            >
            <textarea
              id="linkDescription"
              class="form-input"
              placeholder="Link menuju semua proyek desain saya"
              rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Privasi</label>
            <div class="privacy-options">
              <div class="privacy-option">
                <input
                  type="radio"
                  id="privacyPublic"
                  name="privacy"
                  value="public"
                  checked />
                <label for="privacyPublic">üåç Publik</label>
              </div>
              <div class="privacy-option">
                <input
                  type="radio"
                  id="privacyPrivate"
                  name="privacy"
                  value="private" />
                <label for="privacyPrivate">üîí Pribadi</label>
              </div>
            </div>
          </div>
          <button type="submit" class="btn">üíæ Simpan Link</button>
        </form>
      </div>
    </div>

    <div id="editLinkModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" id="editModalClose">&times;</span>
        <h3 style="margin-bottom: 20px; text-align: left">‚úèÔ∏è Edit Link</h3>
        <form id="editLinkForm" style="text-align: left">
          <input type="hidden" id="editLinkId" />
          <div class="form-group">
            <label for="editLinkTitle" class="form-label">Judul Link</label>
            <input type="text" id="editLinkTitle" class="form-input" required />
          </div>
          <div class="form-group">
            <label for="editLinkUrl" class="form-label">URL</label>
            <input type="url" id="editLinkUrl" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="editLinkFolder">Folder</label>
            <select id="editLinkFolder" class="form-select"></select>
          </div>
          <div class="form-group">
            <label for="editLinkDescription" class="form-label"
              >Deskripsi</label
            >
            <textarea
              id="editLinkDescription"
              class="form-input"
              rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Privasi</label>
            <div class="privacy-options">
              <div class="privacy-option">
                <input
                  type="radio"
                  id="editPrivacyPublic"
                  name="editPrivacy"
                  value="public" />
                <label for="editPrivacyPublic">üåç Publik</label>
              </div>
              <div class="privacy-option">
                <input
                  type="radio"
                  id="editPrivacyPrivate"
                  name="editPrivacy"
                  value="private" />
                <label for="editPrivacyPrivate">üîí Pribadi</label>
              </div>
            </div>
          </div>
          <button type="submit" class="btn">üíæ Simpan Perubahan</button>
        </form>
      </div>
    </div>

    <div id="statusModal" class="modal">
      <div class="modal-content">
        <div id="statusModalIcon" class="modal-icon"></div>
        <h3 id="statusModalTitle" style="margin-bottom: 10px"></h3>
        <p
          id="statusModalMessage"
          style="color: var(--text-secondary); margin-bottom: 25px"></p>
        <button id="statusModalBtn" class="btn"></button>
      </div>
    </div>

    <div id="tagModal" class="modal">
      <div class="modal-content" style="text-align: left">
        <span class="modal-close" id="tagModalClose">&times;</span>
        <h3 id="tagModalTitle" style="margin-bottom: 20px">Kelola Tag untuk</h3>
        <div class="form-group">
          <label class="form-label">Tag Saat Ini</label>
          <div id="currentTags"></div>
        </div>
        <form id="addTagForm" class="form-group">
          <label for="newTagInput" class="form-label">Tambah Tag Baru</label>
          <div style="display: flex; gap: 8px">
            <input
              type="text"
              id="newTagInput"
              class="form-input"
              placeholder="Contoh: Tim Marketing" />
            <button type="submit" class="btn">Tambah</button>
          </div>
        </form>
      </div>
    </div>

    <button id="theme-fab" class="fab">
      <span id="fab-sun-icon">‚òÄÔ∏è</span>
      <span id="fab-moon-icon" class="hidden">üåô</span>
    </button>

    <div id="qrCodeModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" id="qrModalClose">&times;</span>
        <h4 style="margin-bottom: 8px">Kode QR untuk Link</h4>
        <p
          id="qrLinkText"
          style="
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-all;
            margin-bottom: 20px;
          "></p>
        <div
          id="qrcode"
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            width: fit-content;
            margin: 0 auto;
          "></div>
      </div>
    </div>

    <script>
      // Konfigurasi Firebase ini aman untuk ditaruh di sisi klien.
      // Keamanan diatur oleh Firestore Security Rules, bukan dengan menyembunyikan konfigurasi ini.
      const firebaseConfig = {
        apiKey: "AIzaSyAPBg8IE40Zkwy3FnRxyUwwai4Wwuntebw",
        authDomain: "links-6209c.firebaseapp.com",
        projectId: "links-6209c",
        storageBucket: "links-6209c.appspot.com",
        messagingSenderId: "809280798911",
        appId: "1:809280798911:web:44b584a1fe48cd046b060a",
      };

      let auth, db;
      try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
      } catch (error) {
        console.error("Firebase initialization error:", error);
        document.getElementById("authStatus").textContent =
          "Error: Gagal inisialisasi Firebase.";
      }

      // DOM Elements
      const addLinkModal = document.getElementById("addLinkModal");
      const showAddLinkBtn = document.getElementById("showAddLinkBtn");
      const addModalClose = document.getElementById("addModalClose");
      const authContainer = document.getElementById("authContainer");
      const mainContainer = document.getElementById("mainContainer");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const authStatus = document.getElementById("authStatus");
      const userAvatar = document.getElementById("userAvatar");
      const userName = document.getElementById("userName");
      const userEmail = document.getElementById("userEmail");
      const userRoleOrTagsContainer = document.getElementById("userRoleOrTags");
      const adminSection = document.getElementById("adminSection");
      const addLinkSection = document.getElementById("addLinkSection");
      const addLinkForm = document.getElementById("addLinkForm");
      const searchInput = document.getElementById("searchInput");
      const pinnedLinksContainer = document.getElementById(
        "pinnedLinksContainer"
      );
      const regularLinksContainer = document.getElementById(
        "regularLinksContainer"
      );
      const linksContainerPlaceholder = document.getElementById(
        "linksContainerPlaceholder"
      );
      const filterContainer = document.getElementById("filterContainer");
      const pendingUsersContainer = document.getElementById("pendingUsers");
      const allUsersContainer = document.getElementById("allUsers");
      const editLinkModal = document.getElementById("editLinkModal");
      const editModalClose = document.getElementById("editModalClose");
      const editLinkForm = document.getElementById("editLinkForm");
      const statusModal = document.getElementById("statusModal");
      const statusModalBtn = document.getElementById("statusModalBtn");
      const tagModal = document.getElementById("tagModal");
      const tagModalClose = document.getElementById("tagModalClose");
      const addTagForm = document.getElementById("addTagForm");
      const newTagInput = document.getElementById("newTagInput");
      const currentTagsContainer = document.getElementById("currentTags");
      const tagModalTitle = document.getElementById("tagModalTitle");
      const tutorialCard = document.getElementById("tutorialCard");
      const closeTutorialBtn = document.getElementById("closeTutorialBtn");
      const themeFab = document.getElementById("theme-fab");
      const fabSunIcon = document.getElementById("fab-sun-icon");
      const fabMoonIcon = document.getElementById("fab-moon-icon");
      const userLinkStats = document.getElementById("userLinkStats");
      const addFolderForm = document.getElementById("addFolderForm");
      const newFolderInput = document.getElementById("newFolderInput");
      const folderListContainer = document.getElementById("folderList");
      const bulkActionBar = document.getElementById("bulkActionBar");
      const selectionCount = document.getElementById("selectionCount");
      const bulkMoveFolderSelect = document.getElementById(
        "bulkMoveFolderSelect"
      );
      const bulkMoveBtn = document.getElementById("bulkMoveBtn");
      const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
      const userSearchInput = document.getElementById("userSearchInput");

      // Elemen baru untuk mode seleksi
      const selectModeBtn = document.getElementById("selectModeBtn");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const cancelSelectBtn = document.getElementById("cancelSelectBtn");

      const qrCodeModal = document.getElementById("qrCodeModal");
      const qrModalClose = document.getElementById("qrModalClose");
      const qrcodeContainer = document.getElementById("qrcode");
      const qrLinkText = document.getElementById("qrLinkText");
      let qrcode = null; // Variabel untuk menyimpan instance QR code

      let currentUser = null;
      let isAdmin = false;
      let allLinks = [];
      let allFolders = [];
      let selectedLinks = new Set();
      let unsubscribes = [];
      let userChartInstance = null;
      // ### Kode Baru ###
      let activeFilters = {
        mode: "all",
        tags: [],
        folderId: "all",
        sortBy: "newest",
      };
      let currentEditingUserId = null;
      let completeUserList = [];

      auth.onAuthStateChanged((user) => {
        unsubscribes.forEach((unsub) => unsub());
        unsubscribes = [];

        if (user) {
          currentUser = user;
          handleUserStatus(user);
        } else {
          currentUser = null;
          isAdmin = false;
          showAuthInterface();
        }
      });

      function showQrCode(url, title) {
        qrLinkText.textContent = url;

        // Hapus kode QR lama jika ada
        qrcodeContainer.innerHTML = "";

        // Buat instance QRCode baru
        qrcode = new QRCode(qrcodeContainer, {
          text: url,
          width: 200,
          height: 200,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        // Tampilkan modal
        qrCodeModal.classList.add("show");
      }

      // --- Logika untuk Menutup Modal ---
      qrModalClose.addEventListener("click", () => {
        qrCodeModal.classList.remove("show");
      });

      // Tutup modal jika mengklik di luar konten
      window.addEventListener("click", (event) => {
        if (event.target == qrCodeModal) {
          qrCodeModal.classList.remove("show");
        }

        if (event.target == addLinkModal) {
          addLinkModal.classList.remove("show");
        }
      });

      // ### KODE BARU YANG DIPERBAIKI ###
      function filterAndDisplayUsers() {
        const searchTerm = userSearchInput.value.toLowerCase();

        // 1. Pertama, saring daftar utama untuk mendapatkan HANYA pengguna yang disetujui.
        const approvedUsers = completeUserList.filter(
          (user) => user.status === "approved"
        );

        // 2. Jika kotak pencarian kosong, tampilkan semua pengguna yang SUDAH disetujui.
        if (!searchTerm) {
          displayAllUsers(approvedUsers);
          return;
        }

        // 3. Jika ada teks pencarian, filter dari daftar pengguna yang SUDAH disetujui.
        const filteredUsers = approvedUsers.filter((user) => {
          const name = user.displayName?.toLowerCase() || "";
          const email = user.email?.toLowerCase() || "";
          return name.includes(searchTerm) || email.includes(searchTerm);
        });

        // 4. Tampilkan hasil akhir yang sudah benar.
        displayAllUsers(filteredUsers);
      }

      function handleUserStatus(user) {
        const userDocRef = db.collection("users").doc(user.uid);

        const userStatusListener = userDocRef.onSnapshot(
          async (doc) => {
            if (!doc.exists) {
              await userDocRef.set({
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                status: "pending",
                role: "user",
                tags: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              return;
            }

            const userData = doc.data();
            // Menjadi ini:
            currentUser.role = userData.role;
            currentUser.tags = userData.tags || [];
            // Buat Set untuk mengecek pin dengan cepat
            currentUser.pinnedLinks = new Set(userData.pinnedLinks || []);

            // Perintahkan untuk menggambar ulang link setiap kali ada perubahan pada data user (termasuk pin)
            if (allLinks.length > 0) {
              // Hanya render jika link sudah dimuat
              applyFilters();
            }

            switch (userData.status) {
              case "approved":
                hideStatusModal();
                isAdmin = userData.role === "admin";
                showMainInterface();
                listenToFolders(); // <-- FUNGSI YANG DIPERBAIKI
                loadLinksRealtime();
                if (isAdmin) {
                  initializeAdminDashboard();
                } else {
                  adminSection.classList.add("hidden");
                }
                // addLinkSection.classList.remove("hidden");
                break;
              case "pending":
                showStatusModal("pending");
                break;
              case "rejected":
                showStatusModal("rejected");
                break;
              default:
                auth.signOut();
                break;
            }
          },
          (error) => {
            console.error("Error listening to user status:", error);
            auth.signOut();
          }
        );
        unsubscribes.push(userStatusListener);
      }

      function showStatusModal(status) {
        showAuthInterface();
        mainContainer.classList.add("hidden");

        const icon = document.getElementById("statusModalIcon");
        const title = document.getElementById("statusModalTitle");
        const message = document.getElementById("statusModalMessage");

        if (status === "pending") {
          icon.textContent = "‚è≥";
          title.textContent = "Menunggu Persetujuan";
          message.textContent =
            "Akun Anda sedang ditinjau. Anda akan otomatis masuk setelah disetujui.";
          statusModalBtn.textContent = "Keluar";
          statusModalBtn.onclick = () => auth.signOut();
          statusModalBtn.className = "btn btn-secondary";
        } else {
          // rejected
          icon.textContent = "‚ùå";
          title.textContent = "Akses Ditolak";
          message.innerHTML =
            'Maaf, pendaftaran Anda ditolak. <br>Silakan hubungi admin di WA <a href="https://wa.me/628998419000" target="_blank">08998419000</a>.';
          statusModalBtn.textContent = "Kembali ke Halaman Login";
          statusModalBtn.onclick = () => auth.signOut();
          statusModalBtn.className = "btn btn-danger";
        }
        statusModal.classList.add("show");
      }

      function hideStatusModal() {
        statusModal.classList.remove("show");
      }

      function showAuthInterface() {
        authContainer.classList.remove("hidden");
        mainContainer.classList.add("hidden");
        adminSection.classList.add("hidden");
        // addLinkSection.classList.add("hidden");
        userLinkStats.classList.add("hidden");
        hideStatusModal();
      }

      function showMainInterface() {
        authContainer.classList.add("hidden");
        mainContainer.classList.remove("hidden");
        userLinkStats.classList.remove("hidden");
        userAvatar.src =
          currentUser.photoURL ||
          "https://placehold.co/40x40/E2E8F0/64748B?text=A";
        userName.textContent = currentUser.displayName || currentUser.email;
        userEmail.textContent = currentUser.email;

        userRoleOrTagsContainer.innerHTML = ""; // Clear previous
        if (isAdmin) {
          userRoleOrTagsContainer.innerHTML = `<span class="tag-badge" style="background-color: var(--warning-color); color: #fffbeb;">Admin</span>`;
        } else if (currentUser.tags && currentUser.tags.length > 0) {
          const tagsHTML = currentUser.tags
            .map((tag) => `<span class="tag-badge">#${escapeHtml(tag)}</span>`)
            .join("");
          userRoleOrTagsContainer.innerHTML = tagsHTML;
        }
      }

      bulkDeleteBtn.addEventListener("click", handleBulkDelete);
      bulkMoveBtn.addEventListener("click", handleBulkMove);
      userSearchInput.addEventListener("input", filterAndDisplayUsers);

      loginBtn.addEventListener("click", async () => {
        authStatus.textContent = "Membuka jendela login...";
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
        } catch (error) {
          console.error("Login error:", error);
          authStatus.textContent = `Gagal login. Coba lagi.`;
        }
      });

      logoutBtn.addEventListener("click", () => auth.signOut());

      addLinkForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const urlInput = document.getElementById("linkUrl");
        let url = urlInput.value;
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
          url = "https://" + url;
        }

        try {
          const userDoc = await db
            .collection("users")
            .doc(currentUser.uid)
            .get();
          const userTags = userDoc.exists ? userDoc.data().tags || [] : [];
          const folderId = document.getElementById("linkFolder").value;

          await db.collection("links").add({
            title: document.getElementById("linkTitle").value,
            url: url,
            description: document.getElementById("linkDescription").value,
            privacy: document.querySelector('input[name="privacy"]:checked')
              .value,
            userId: currentUser.uid,
            userName: currentUser.displayName || currentUser.email,
            userTags: userTags,
            folderId: folderId || null,
            isPinned: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          addLinkForm.reset();
          showMessage("Link berhasil ditambahkan!", "success");
        } catch (error) {
          console.error(error);
          showMessage("Gagal menambahkan link.", "error");
        }
      });

      // --- LOGIKA UNTUK MODAL TAMBAH LINK ---

      // Tampilkan modal saat tombol utama diklik
      showAddLinkBtn.addEventListener("click", () => {
        addLinkModal.classList.add("show");
      });

      // Sembunyikan modal saat tombol close (x) diklik
      addModalClose.addEventListener("click", () => {
        addLinkModal.classList.remove("show");
      });

      // Sembunyikan modal jika pengguna mengklik area di luar konten modal
      // (Kita bisa tambahkan logika ini ke event listener window yang sudah ada)

      function loadLinksRealtime() {
        if (!currentUser) return;

        linksContainerPlaceholder.classList.remove("hidden");
        pinnedLinksContainer.innerHTML = "";
        regularLinksContainer.innerHTML = "";

        const linksMap = new Map();

        const processAndDisplay = () => {
          allLinks = Array.from(linksMap.values()).sort(
            (a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)
          );

          updateLinkStats();
          updateActionFolderDropdowns(allFolders);
          renderFilters();

          const folderCounts = countLinksInFolders();
          if (isAdmin) {
            renderFolderList(allFolders, folderCounts);
          }

          applyFilters();
        };

        const publicQuery = db
          .collection("links")
          .where("privacy", "==", "public");
        const publicUnsubscribe = publicQuery.onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "removed") linksMap.delete(change.doc.id);
            else
              linksMap.set(change.doc.id, {
                id: change.doc.id,
                ...change.doc.data(),
              });
          });
          processAndDisplay();
        }, console.error);

        const privateQuery = db
          .collection("links")
          .where("userId", "==", currentUser.uid);
        const privateUnsubscribe = privateQuery.onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "removed") {
              linksMap.delete(change.doc.id);
            } else {
              // Make sure we don't add public links twice
              if (change.doc.data().privacy !== "public") {
                linksMap.set(change.doc.id, {
                  id: change.doc.id,
                  ...change.doc.data(),
                });
              }
            }
          });
          processAndDisplay();
        }, console.error);

        unsubscribes.push(publicUnsubscribe, privateUnsubscribe);
      }

      function updateLinkStats() {
        const myLinks = allLinks.filter(
          (link) => link.userId === currentUser.uid
        );
        userLinkStats.innerHTML = `
            <h4 style="margin-bottom: 16px; text-align: center;">Statistik Link Saya</h4>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div><div style="font-size: 1.5rem; font-weight: bold;">${
                  myLinks.length
                }</div><div style="color: var(--text-secondary);">Total</div></div>
                <div><div style="font-size: 1.5rem; font-weight: bold;">${
                  myLinks.filter((l) => l.privacy === "public").length
                }</div><div style="color: var(--text-secondary);">Publik</div></div>
                <div><div style="font-size: 1.5rem; font-weight: bold;">${
                  myLinks.filter((l) => l.privacy === "private").length
                }</div><div style="color: var(--text-secondary);">Pribadi</div></div>
            </div>`;

        if (isAdmin) {
          const linkStatsContainer =
            document.getElementById("linkStatsContainer");
          if (linkStatsContainer) {
            linkStatsContainer.innerHTML = `
                      <div style="display: flex; justify-content: space-around; text-align: center;">
                          <div>
                              <div style="font-size: 2rem; font-weight: bold;">${allLinks.length}</div>
                              <div style="color: var(--text-secondary);">Total Link Terlihat</div>
                          </div>
                      </div>
                  `;
          }
        }
      }

      function renderFilters() {
        const folderCounts = countLinksInFolders();

        // --- Bagian Kiri: Membuat elemen filter ---
        let folderFilterHTML = `<select id="folderFilter" class="folder form-select" style="width: auto;"><option value="all">Semua Folder</option>`;
        allFolders.forEach((folder) => {
          const count = folderCounts[folder.id] || 0;
          folderFilterHTML += `<option value="${folder.id}" ${
            activeFilters.folderId === folder.id ? "selected" : ""
          }>${escapeHtml(folder.name)} (${count})</option>`;
        });
        folderFilterHTML += "</select>";

        const uniqueTags = [
          ...new Set(allLinks.flatMap((link) => link.userTags || [])),
        ];
        let modeButtonsHTML = `
            <button class="filter-btn mode-filter" data-mode="all">üåç Publik</button>
            <button class="filter-btn mode-filter" data-mode="myLinks">üßë‚Äçüíª Milik Saya</button>
            <button class="filter-btn mode-filter" data-mode="private">üîí Pribadi</button>
        `;
        let tagsHTML = uniqueTags
          .sort()
          .map(
            (tag) =>
              `<button class="filter-btn tag-filter" data-tag="${tag}">#${escapeHtml(
                tag
              )}</button>`
          )
          .join("");

        // ### Kode Baru yang Diperbarui ###
        const sortOptionsHTML = `
  <select id="sortSelect" class="folder form-select" style="width: auto;">
    <option value="newest" ${
      activeFilters.sortBy === "newest" ? "selected" : ""
    }>Terbaru</option>
    <option value="oldest" ${
      activeFilters.sortBy === "oldest" ? "selected" : ""
    }>Terlama</option>
    <option value="title" ${
      activeFilters.sortBy === "title" ? "selected" : ""
    }>Judul (A-Z)</option>
  </select>
`;

        const leftSideFilters = `<div class="filter-group">${folderFilterHTML}${sortOptionsHTML}${modeButtonsHTML}${
          tagsHTML
            ? `<span style="border-left: 1px solid var(--border-color); margin: 0 8px;"></span>` +
              tagsHTML
            : ""
        }</div>`;

        const inSelectionMode =
          document.body.classList.contains("selection-mode");
        const rightSideActions = `
            <div id="selection-controls" style="display: flex; gap: 8px;">
                <button id="selectModeBtn" class="filter-btn ${
                  inSelectionMode ? "hidden" : ""
                }">Pilih</button>
                <button id="selectAllBtn" class="filter-btn ${
                  inSelectionMode ? "" : "hidden"
                }">Pilih Semua</button>
                <button id="cancelSelectBtn" class="filter-btn ${
                  inSelectionMode ? "" : "hidden"
                }" style="background-color: var(--danger-color); color: white; border-color: var(--danger-color);">Batal</button>
            </div>`;

        filterContainer.innerHTML = leftSideFilters + rightSideActions;

        // Terapkan kelas 'active'
        document
          .querySelector(`.mode-filter[data-mode="${activeFilters.mode}"]`)
          ?.classList.add("active");
        activeFilters.tags.forEach((tag) => {
          document
            .querySelector(`.tag-filter[data-tag="${tag}"]`)
            ?.classList.add("active");
        });
        // ### Tambahkan kode ini di dalam renderFilters ###

        document
          .getElementById("sortSelect")
          .addEventListener("change", (e) => {
            activeFilters.sortBy = e.target.value;
            applyFilters();
          });
        // ================================================================
        // BLOK EVENT LISTENER DENGAN LOGIKA "PILIH SEMUA" YANG DISEMPURNAKAN
        // ================================================================
        document
          .getElementById("selectModeBtn")
          .addEventListener("click", () => {
            document.body.classList.add("selection-mode");
            renderFilters(); // Render ulang untuk menampilkan tombol yang benar
          });

        document
          .getElementById("cancelSelectBtn")
          .addEventListener("click", exitSelectionMode);

        document
          .getElementById("selectAllBtn")
          .addEventListener("click", () => {
            // 1. Jalankan semua filter (folder, tag, dll)
            let filteredLinks = [...allLinks];
            if (activeFilters.mode === "myLinks") {
              filteredLinks = filteredLinks.filter(
                (link) => link.userId === currentUser.uid
              );
            }
            if (activeFilters.folderId !== "all") {
              filteredLinks = filteredLinks.filter(
                (link) => (link.folderId || "") === activeFilters.folderId
              );
            }
            if (activeFilters.tags.length > 0) {
              filteredLinks = filteredLinks.filter((link) =>
                activeFilters.tags.every((tag) =>
                  (link.userTags || []).includes(tag)
                )
              );
            }

            // 2. JALANKAN JUGA FILTER PENCARIAN TEKS
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
              filteredLinks = filteredLinks.filter((link) =>
                Object.values(link).some((val) =>
                  String(val).toLowerCase().includes(searchTerm)
                )
              );
            }

            const filteredLinkIds = filteredLinks.map((link) => link.id);
            const allVisibleSelected =
              filteredLinkIds.length > 0 &&
              filteredLinkIds.every((id) => selectedLinks.has(id));

            if (allVisibleSelected) {
              filteredLinkIds.forEach((id) => selectedLinks.delete(id));
            } else {
              filteredLinkIds.forEach((id) => selectedLinks.add(id));
            }

            updateBulkActionBar();
            applyFilters();
          });

        document
          .getElementById("folderFilter")
          .addEventListener("change", (e) => {
            activeFilters.folderId = e.target.value;
            applyFilters();
          });
        document.querySelectorAll(".mode-filter").forEach((btn) => {
          btn.addEventListener("click", () => {
            activeFilters.mode = btn.dataset.mode;
            applyFilters();
          });
        });
        document.querySelectorAll(".tag-filter").forEach((btn) => {
          btn.addEventListener("click", () => {
            const tag = btn.dataset.tag;
            const index = activeFilters.tags.indexOf(tag);
            if (index > -1) {
              activeFilters.tags.splice(index, 1);
            } else {
              activeFilters.tags.push(tag);
            }
            applyFilters();
          });
        });
      }
      // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
      function exitSelectionMode() {
        document.body.classList.remove("selection-mode");

        // ================================================================
        // BAGIAN YANG DIPERBAIKI:
        // Cari elemen tombol langsung di sini, jangan pakai variabel global
        // ================================================================
        const selectModeBtn = document.getElementById("selectModeBtn");
        const selectAllBtn = document.getElementById("selectAllBtn");
        const cancelSelectBtn = document.getElementById("cancelSelectBtn");

        if (selectModeBtn) selectModeBtn.classList.remove("hidden");
        if (selectAllBtn) selectAllBtn.classList.add("hidden");
        if (cancelSelectBtn) cancelSelectBtn.classList.add("hidden");

        selectedLinks.clear();
        updateBulkActionBar();

        document.querySelectorAll(".link-card.selected").forEach((card) => {
          card.classList.remove("selected");
        });

        applyFilters();
      }

      function applyFilters() {
        renderFilters(); // Tetap di sini untuk memperbarui UI tombol

        // 1. Mulai dengan daftar link lengkap
        let filteredLinks = [...allLinks];

        // 2. Terapkan filter mode, folder, dan tag
        if (activeFilters.mode === "myLinks") {
          filteredLinks = filteredLinks.filter(
            (link) => link.userId === currentUser.uid
          );
        } else if (activeFilters.mode === "private") {
          // LOGIKA BARU: Tampilkan hanya link pribadi milik pengguna saat ini
          filteredLinks = filteredLinks.filter(
            (link) =>
              link.privacy === "private" && link.userId === currentUser.uid
          );
        }
        if (activeFilters.folderId !== "all") {
          filteredLinks = filteredLinks.filter(
            (link) => (link.folderId || "") === activeFilters.folderId
          );
        }
        if (activeFilters.tags.length > 0) {
          filteredLinks = filteredLinks.filter((link) =>
            activeFilters.tags.every((tag) =>
              (link.userTags || []).includes(tag)
            )
          );
        }

        // ================================================================
        // BAGIAN YANG DIPERBAIKI:
        // 3. Terapkan juga filter dari teks pencarian
        // ================================================================
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
          filteredLinks = filteredLinks.filter((link) =>
            Object.values(link).some((val) =>
              String(val).toLowerCase().includes(searchTerm)
            )
          );
        }

        // 4. Lakukan PENGURUTAN pada hasil yang sudah difilter
        if (activeFilters.sortBy === "oldest") {
          filteredLinks.sort(
            (a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)
          );
        } else if (activeFilters.sortBy === "title") {
          filteredLinks.sort((a, b) => a.title.localeCompare(b.title));
        } else {
          // Default ke 'newest'
          filteredLinks.sort(
            (a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)
          );
        }

        // 5. Tampilkan hasil akhir yang sudah terfilter DAN terurut
        displayLinks(filteredLinks);
      }

      // ================================================================
      // BAGIAN YANG DIPERBAIKI:
      // Hapus pemanggilan renderFilters() dari sini.
      // Fungsi ini sekarang hanya fokus menampilkan link yang sudah difilter.

      function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) {
          return "";
        }
        const date = timestamp.toDate();
        return date
          .toLocaleString("id-ID", {
            day: "numeric",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          })
          .replace(/\./g, ":");
      }

      // --- BULK ACTION FUNCTIONS ---

      async function handleBulkDelete() {
        const linksToDelete = Array.from(selectedLinks);
        if (linksToDelete.length === 0) return;
        if (
          !confirm(
            `Yakin ingin menghapus ${linksToDelete.length} link yang dipilih?`
          )
        )
          return;

        const batch = db.batch();
        let deletedCount = 0;
        let permissionErrors = 0;

        // Loop melalui setiap link yang dipilih
        for (const linkId of linksToDelete) {
          const linkData = allLinks.find((link) => link.id === linkId);
          if (!linkData) continue;

          // Pengecekan Izin: Pengguna adalah pemilik ATAU pengguna adalah admin
          if (linkData.userId === currentUser.uid || isAdmin) {
            const linkRef = db.collection("links").doc(linkId);
            batch.delete(linkRef);
            deletedCount++;
          } else {
            permissionErrors++;
          }
        }

        try {
          await batch.commit(); // Kirim semua permintaan hapus sekaligus
          if (deletedCount > 0) {
            showMessage(`${deletedCount} link berhasil dihapus.`, "success");
          }
          if (permissionErrors > 0) {
            showMessage(
              `${permissionErrors} link tidak dihapus karena bukan milik Anda.`,
              "warning"
            );
            exitSelectionMode();
          }
          selectedLinks.clear();
          updateBulkActionBar(); // Sembunyikan action bar
          // UI akan diperbarui otomatis oleh listener realtime
        } catch (error) {
          console.error("Error bulk deleting links:", error);
          showMessage("Gagal menghapus link secara massal.", "error");
        }
      }

      async function handleBulkMove() {
        const linksToMove = Array.from(selectedLinks);
        // Ambil folder tujuan dari dropdown, atau null jika "Tidak ada folder"
        const targetFolderId = bulkMoveFolderSelect.value || null;
        if (linksToMove.length === 0) return;

        const batch = db.batch();
        let movedCount = 0;
        let permissionErrors = 0;

        for (const linkId of linksToMove) {
          const linkData = allLinks.find((link) => link.id === linkId);
          if (!linkData) continue;

          // Pengecekan Izin: Pengguna adalah pemilik ATAU pengguna adalah admin
          if (linkData.userId === currentUser.uid || isAdmin) {
            const linkRef = db.collection("links").doc(linkId);
            batch.update(linkRef, { folderId: targetFolderId });
            movedCount++;
          } else {
            permissionErrors++;
          }
        }

        try {
          await batch.commit(); // Kirim semua permintaan update sekaligus
          if (movedCount > 0) {
            showMessage(`${movedCount} link berhasil dipindahkan.`, "success");
          }
          if (permissionErrors > 0) {
            showMessage(
              `${permissionErrors} link tidak dipindahkan karena bukan milik Anda.`,
              "warning"
            );
            exitSelectionMode();
          }
          selectedLinks.clear();
          updateBulkActionBar(); // Sembunyikan action bar
          // UI akan diperbarui otomatis oleh listener realtime
        } catch (error) {
          console.error("Error bulk moving links:", error);
          showMessage("Gagal memindahkan link secara massal.", "error");
        }
      }

      function displayLinks(links) {
        linksContainerPlaceholder.classList.add("hidden");

        // ================================================================
        // BAGIAN YANG DIPERBAIKI:
        // Filter link berdasarkan daftar pin PRIBADI milik currentUser
        // ================================================================
        const pinnedLinks = links.filter(
          (link) =>
            currentUser.pinnedLinks && currentUser.pinnedLinks.has(link.id)
        );
        const regularLinks = links.filter(
          (link) =>
            !currentUser.pinnedLinks || !currentUser.pinnedLinks.has(link.id)
        );

        // Sisa kode di bawah ini sebagian besar sama, hanya untuk menampilkan hasil filter
        pinnedLinksContainer.innerHTML =
          pinnedLinks.length > 0
            ? `<h3 class="section-title">‚≠ê Favorit</h3>` +
              pinnedLinks.map((link) => renderLinkCard(link)).join("")
            : "";

        let regularLinksHTML = "";
        if (regularLinks.length > 0) {
          // Hanya tampilkan judul "Link Lainnya" jika ada link yang di-pin
          if (pinnedLinks.length > 0) {
            regularLinksHTML += `<h3 class="section-title">Link Lainnya</h3>`;
          }
          regularLinksHTML += regularLinks
            .map((link) => renderLinkCard(link))
            .join("");
        }
        regularLinksContainer.innerHTML = regularLinksHTML;

        if (links.length === 0) {
          regularLinksContainer.innerHTML = `<div class="empty-state" style="padding: 40px 20px; text-align: center;"><h3>Tidak ada link yang ditemukan</h3><p>Coba buat link baru atau ubah filter pencarian Anda.</p></div>`;
        }
      }

      function renderLinkCard(link) {
        const isOwner = currentUser && link.userId === currentUser.uid;
        const isSelected = selectedLinks.has(link.id);
        const isPinned =
          currentUser.pinnedLinks && currentUser.pinnedLinks.has(link.id);
        const tagsHTML = (link.userTags || [])
          .map((tag) => `<span class="tag-badge">#${escapeHtml(tag)}</span>`)
          .join("");

        return `
            <div class="link-card ${
              isSelected ? "selected" : ""
            }" data-link-id="${link.id}">
                <input type="checkbox" class="link-checkbox" data-id="${
                  link.id
                }" ${
          isSelected ? "checked" : ""
        } onchange="toggleLinkSelection('${link.id}', this)">
                <div class="link-card-main">
                    <div class="link-title">${escapeHtml(link.title)}</div>
                    <div class="link-author-date">
                        oleh ${escapeHtml(link.userName)} ‚Ä¢ ${formatTimestamp(
          link.createdAt
        )}
                    </div>
                    <a href="${escapeHtml(
                      link.url
                    )}" target="_blank" class="link-url truncate-text" title="${escapeHtml(
          link.url
        )}">${escapeHtml(link.url)}</a>
                    ${
                      link.description
                        ? `<p>${escapeHtml(link.description)}</p>`
                        : ""
                    }
                    <div class="link-meta">
                        <div class="badges-container">
                            <span class="privacy-badge privacy-${
                              link.privacy
                            }">${
          link.privacy === "public" ? "üåç Publik" : "üîí Pribadi"
        }</span>
                            ${tagsHTML}
                        </div>
                        
                        <div class="link-actions-card">
                            <button class="btn btn-secondary" title="Salin Link" onclick="copyToClipboard('${escapeHtml(
                              link.url
                            )}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <button class="btn btn-secondary" title="Tampilkan Kode QR" onclick="showQrCode('${escapeHtml(
                              link.url
                            )}', '${escapeHtml(link.title)}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><line x1="14" y1="14" x2="14" y2="21"></line><line x1="21" y1="14" x2="21" y2="21"></line><line x1="14" y1="14" x2="17" y2="17"></line><line x1="18" y1="21" x2="21" y2="18"></line></svg>
                            </button>
                            ${
                              isOwner
                                ? `
                            <button class="btn btn-warning" title="Edit Link" onclick="openEditModal('${link.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="btn btn-danger" title="Hapus Link" onclick="deleteLink('${link.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                            `
                                : ""
                            }
                        </div>
                    </div>
                </div>
                <div class="link-card-actions">
                    <span class="pin-btn ${
                      isPinned ? "pinned" : ""
                    }" onclick="togglePin('${link.id}')">üìå</span>
                </div>
            </div>`;
      }

      searchInput.addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredLinks = allLinks.filter((link) =>
          Object.values(link).some((val) =>
            String(val).toLowerCase().includes(searchTerm)
          )
        );
        displayLinks(filteredLinks);
      });

      async function deleteLink(linkId) {
        if (!confirm("Yakin ingin menghapus link ini?")) return;
        try {
          await db.collection("links").doc(linkId).delete();
          showMessage("Link berhasil dihapus!", "success");
        } catch (error) {
          showMessage("Gagal menghapus link.", "error");
        }
      }

      async function togglePin(linkId) {
        if (!currentUser) return;

        const userRef = db.collection("users").doc(currentUser.uid);
        const isCurrentlyPinned = currentUser.pinnedLinks.has(linkId);

        // Gunakan arrayUnion untuk menambah & arrayRemove untuk menghapus
        const updateData = {
          pinnedLinks: isCurrentlyPinned
            ? firebase.firestore.FieldValue.arrayRemove(linkId) // Jika sudah di-pin, hapus
            : firebase.firestore.FieldValue.arrayUnion(linkId), // Jika belum, tambahkan
        };

        try {
          await userRef.update(updateData);
          // Listener onSnapshot pada data pengguna akan menangani pembaruan UI secara otomatis
          showMessage(
            `Link berhasil di-${!isCurrentlyPinned ? "sematkan" : "lepas"}!`,
            "success"
          );
        } catch (error) {
          console.error("Gagal memperbarui status pin:", error);
          showMessage("Gagal mengubah status pin.", "error");
        }
      }

      function openEditModal(linkId) {
        const linkData = allLinks.find((link) => link.id === linkId);
        if (!linkData) return;

        editLinkId.value = linkId;
        editLinkTitle.value = linkData.title;
        editLinkUrl.value = linkData.url;
        editLinkDescription.value = linkData.description || "";
        document.querySelector(
          `input[name="editPrivacy"][value="${linkData.privacy}"]`
        ).checked = true;

        const folderSelect = document.getElementById("editLinkFolder");
        folderSelect.value = linkData.folderId || "";

        editLinkModal.classList.add("show");
      }

      editModalClose.addEventListener("click", () =>
        editLinkModal.classList.remove("show")
      );

      editLinkForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const linkId = editLinkId.value;
        const updatedData = {
          title: editLinkTitle.value,
          url: editLinkUrl.value,
          description: editLinkDescription.value,
          privacy: document.querySelector('input[name="editPrivacy"]:checked')
            .value,
          folderId: document.getElementById("editLinkFolder").value || null,
        };

        try {
          await db.collection("links").doc(linkId).update(updatedData);
          editLinkModal.classList.remove("show");
          showMessage("Link berhasil diperbarui!", "success");
        } catch (error) {
          showMessage("Gagal memperbarui link.", "error");
        }
      });

      // --- ADMIN FUNCTIONS ---
      function initializeAdminDashboard() {
        adminSection.classList.remove("hidden");
        setupAdminTabs();
        loadAllUsersRealtime();
      }

      function setupAdminTabs() {
        const tabs = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((item) => item.classList.remove("active"));
            tab.classList.add("active");
            const target = document.getElementById(tab.dataset.tab + "Content");
            tabContents.forEach((content) =>
              content.classList.remove("active")
            );
            target.classList.add("active");
          });
        });
      }

      function loadAllUsersRealtime() {
        if (!isAdmin) return;
        const query = db.collection("users").orderBy("createdAt", "desc");

        const allUsersListener = query.onSnapshot((snapshot) => {
          const allUsersData = [];
          const pendingUsers = [];
          const blockedUsers = []; // <-- Tambahkan ini

          snapshot.forEach((doc) => {
            const userData = { id: doc.id, ...doc.data() };
            allUsersData.push(userData);
            if (userData.status === "pending") {
              pendingUsers.push(userData);
            } else if (userData.status === "rejected") {
              // <-- Tambahkan kondisi ini
              blockedUsers.push(userData);
            }
          });

          completeUserList = allUsersData;

          // --- Update Badges ---
          const pendingBadge = document.getElementById("pendingCountBadge");
          const totalUsersBadge = document.getElementById("totalUsersBadge");
          const blockedBadge = document.getElementById("blockedCountBadge"); // <-- Badge baru

          // Badge Pending
          if (pendingUsers.length > 0) {
            pendingBadge.textContent = pendingUsers.length;
            pendingBadge.classList.add("visible");
          } else {
            pendingBadge.classList.remove("visible");
          }

          // Badge Blocked
          if (blockedUsers.length > 0) {
            blockedBadge.textContent = blockedUsers.length;
            blockedBadge.classList.add("visible");
          } else {
            blockedBadge.classList.remove("visible");
          }

          // Badge Total Users (hanya yang approved)
          const approvedUsersCount = allUsersData.filter(
            (u) => u.status === "approved"
          ).length;
          if (approvedUsersCount > 0) {
            totalUsersBadge.textContent = approvedUsersCount;
            totalUsersBadge.classList.add("visible");
          } else {
            totalUsersBadge.classList.remove("visible");
          }

          displayPendingUsers(pendingUsers);
          displayBlockedUsers(blockedUsers); // <-- Panggil fungsi baru
          filterAndDisplayUsers(); // Ini akan memfilter pengguna aktif
          updateUserChart(allUsersData);
        }, console.error);
        unsubscribes.push(allUsersListener);
      }

      function displayBlockedUsers(users) {
        const container = document.getElementById("blockedUsersList");
        if (users.length === 0) {
          container.innerHTML =
            '<p style="color: var(--text-secondary);">Tidak ada pengguna yang diblokir.</p>';
          return;
        }

        container.innerHTML = users
          .map((userData) => {
            const isSelf = currentUser.uid === userData.id;
            return `
        <div class="user-list-item">
            <div class="user-list-info">
                <img src="${
                  userData.photoURL ||
                  "https://placehold.co/32x32/E2E8F0/64748B?text=A"
                }" alt="Avatar" class="user-list-avatar">
                <div>
                    <div style="font-weight: 500;">${escapeHtml(
                      userData.displayName
                    )}</div>
                    <div style="color: var(--text-secondary); font-size: 13px;">${escapeHtml(
                      userData.email
                    )}</div>
                </div>
            </div>
            <div class="link-actions">
                ${
                  !isSelf
                    ? `
                    <button class="btn btn-success" onclick="updateUserStatus('${
                      userData.id
                    }', 'approved')" style="padding: 6px 12px; font-size: 12px;">Buka Blokir</button>
                    <button class="btn btn-danger" onclick="deleteUser('${
                      userData.id
                    }', '${escapeHtml(
                        userData.displayName
                      )}')" style="padding: 6px 12px; font-size: 12px;">Hapus Permanen</button>
                `
                    : ""
                }
            </div>
        </div>`;
          })
          .join("");
      }

      function exportUsersToCSV(users, filename) {
        if (users.length === 0) {
          showMessage("Tidak ada data untuk diekspor.", "warning");
          return;
        }

        // Header CSV
        const csvHeader = "Nama,Email\n";

        // Baris-baris data
        const csvRows = users
          .map((user) => {
            const name = user.displayName || "N/A";
            const email = user.email || "N/A";
            // Menangani koma atau tanda kutip di dalam nama
            const escapedName = `"${name.replace(/"/g, '""')}"`;
            return [escapedName, email].join(",");
          })
          .join("\n");

        const csvContent = csvHeader + csvRows;

        // Membuat dan mengunduh file
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      function displayPendingUsers(users) {
        if (users.length === 0) {
          pendingUsersContainer.innerHTML =
            '<p style="color: var(--text-secondary);">Tidak ada pengguna yang menunggu persetujuan.</p>';
          return;
        }
        pendingUsersContainer.innerHTML = users
          .map(
            (userData) => `
            <div class="user-list-item">
                <div class="user-list-info">
                <img src="${
                  userData.photoURL ||
                  "https://placehold.co/32x32/E2E8F0/64748B?text=A"
                }" alt="Avatar" class="user-list-avatar">
                <div>
                    <div style="font-weight: 500;">${escapeHtml(
                      userData.displayName || userData.email
                    )}</div>
                    <div style="color: var(--text-secondary); font-size: 14px;">${escapeHtml(
                      userData.email
                    )}</div>
                </div>
                </div>
                <div class="link-actions">
                <button class="btn btn-success" onclick="updateUserStatus('${
                  userData.id
                }', 'approved')" style="padding: 6px 12px; font-size: 12px;">‚úÖ Setujui</button>
                <button class="btn btn-danger" onclick="updateUserStatus('${
                  userData.id
                }', 'rejected')" style="padding: 6px 12px; font-size: 12px;">‚ùå Tolak</button>
                </div>
            </div>
        `
          )
          .join("");
      }

      function displayAllUsers(users) {
        allUsersContainer.innerHTML = users
          .map((userData) => {
            const isSelf = currentUser.uid === userData.id;
            const tagsHTML = (userData.tags || [])
              .map(
                (tag) => `<span class="tag-badge">#${escapeHtml(tag)}</span>`
              )
              .join("");
            return `
            <div class="user-list-item">
                <div class="user-list-info">
                    <img src="${
                      userData.photoURL ||
                      "https://placehold.co/32x32/E2E8F0/64748B?text=A"
                    }" alt="Avatar" class="user-list-avatar">
                    <div>
                        <div style="font-weight: 500;">${escapeHtml(
                          userData.displayName
                        )}</div>
                        <div style="color: var(--text-secondary); font-size: 13px;">${escapeHtml(
                          userData.email
                        )}</div>
                        <div class="badges-container" style="margin-top: 4px;">
                            ${tagsHTML}
                        </div>
                    </div>
                </div>
                <div class="link-actions">
                    ${
                      !isSelf
                        ? `<button class="btn btn-info" onclick="openTagModal('${
                            userData.id
                          }', '${escapeHtml(
                            userData.displayName
                          )}')" style="padding: 6px 12px; font-size: 12px;">Kelola Tag</button>`
                        : ""
                    }
                    ${
                      !isSelf &&
                      (userData.status === "pending" ||
                        userData.status === "rejected")
                        ? `<button class="btn btn-success" onclick="updateUserStatus('${userData.id}', 'approved')" style="padding: 6px 12px; font-size: 12px;">Setujui</button>`
                        : ""
                    }
                    ${
                      !isSelf &&
                      (userData.status === "approved" ||
                        userData.status === "pending")
                        ? `<button class="btn btn-warning" onclick="updateUserStatus('${userData.id}', 'rejected')" style="padding: 6px 12px; font-size: 12px;">Blokir</button>`
                        : ""
                    }
                    ${
                      !isSelf
                        ? `<button class="btn btn-danger" onclick="deleteUser('${
                            userData.id
                          }', '${escapeHtml(
                            userData.displayName
                          )}')" style="padding: 6px 12px; font-size: 12px;">Hapus</button>`
                        : ""
                    }
                </div>
            </div>
        `;
          })
          .join("");
      }

      function updateUserChart(users) {
        const ctx = document.getElementById("userStatsChart").getContext("2d");
        const statusCounts = users.reduce((acc, user) => {
          acc[user.status] = (acc[user.status] || 0) + 1;
          return acc;
        }, {});

        const labels = ["Disetujui", "Menunggu", "Ditolak/Blokir"];
        const data = [
          statusCounts.approved || 0,
          statusCounts.pending || 0,
          statusCounts.rejected || 0,
        ];

        if (userChartInstance) {
          userChartInstance.data.labels = labels;
          userChartInstance.data.datasets[0].data = data;
          userChartInstance.update();
          return;
        }

        userChartInstance = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Pengguna",
                data: data,
                backgroundColor: [
                  "rgba(34, 197, 94, 0.7)",
                  "rgba(245, 158, 11, 0.7)",
                  "rgba(239, 68, 68, 0.7)",
                ],
                borderColor: [
                  "rgba(34, 197, 94, 1)",
                  "rgba(245, 158, 11, 1)",
                  "rgba(239, 68, 68, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
          },
        });
      }

      async function updateUserStatus(userId, status) {
        const action = status === "approved" ? "menyetujui" : "memblokir";
        if (!confirm(`Yakin ingin ${action} pengguna ini?`)) return;
        try {
          await db.collection("users").doc(userId).update({ status: status });
          showMessage(
            `Pengguna berhasil di${
              status === "approved" ? "setujui" : "blokir"
            }!`,
            "success"
          );
        } catch (error) {
          showMessage("Gagal memperbarui status pengguna.", "error");
        }
      }

      async function deleteUser(userIdToDelete, userDisplayName) {
        if (
          !confirm(
            `PERINGATAN: Anda akan menghapus pengguna "${userDisplayName}". SEMUA link milik pengguna ini akan dialihkan ke akun Anda. Yakin ingin melanjutkan?`
          )
        )
          return;

        const admin = currentUser;
        if (!isAdmin || !admin) {
          showMessage(
            "Hanya admin yang dapat melakukan tindakan ini.",
            "error"
          );
          return;
        }

        try {
          // Sanitize display name for the tag
          const safeDisplayName = userDisplayName
            .toLowerCase()
            .replace(/[^a-z0-9]/g, "");
          const migrationTag = `migrasi-${safeDisplayName}`;

          // Step 1: Find all links by the user to be deleted
          const linksQuery = db
            .collection("links")
            .where("userId", "==", userIdToDelete);
          const linksSnapshot = await linksQuery.get();

          // Step 2: Create a batch to update all links
          const batch = db.batch();
          linksSnapshot.forEach((doc) => {
            const linkRef = db.collection("links").doc(doc.id);
            batch.update(linkRef, {
              userId: admin.uid,
              userName: admin.displayName,
              userTags: [migrationTag],
            });
          });

          // Step 3: Commit the batch update for links
          await batch.commit();

          // Step 4: Delete the user document
          await db.collection("users").doc(userIdToDelete).delete();

          showMessage(
            `Pengguna "${userDisplayName}" berhasil dihapus dan ${linksSnapshot.size} link telah dialihkan.`,
            "success"
          );
        } catch (error) {
          console.error("Error deleting user and migrating links:", error);
          showMessage("Gagal menghapus pengguna.", "error");
        }
      }

      tagModalClose.addEventListener("click", () =>
        tagModal.classList.remove("show")
      );

      async function openTagModal(userId, displayName) {
        currentEditingUserId = userId;
        tagModalTitle.textContent = `Kelola Tag untuk ${displayName}`;

        const userDoc = await db.collection("users").doc(userId).get();
        if (!userDoc.exists) return;

        const tags = userDoc.data().tags || [];
        renderCurrentTags(tags);
        tagModal.classList.add("show");
      }

      function renderCurrentTags(tags) {
        currentTagsContainer.innerHTML = tags
          .map(
            (tag) => `
            <span class="tag-item">
                ${escapeHtml(tag)}
                <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
            </span>
        `
          )
          .join("");
      }

      function toggleLinkSelection(linkId, checkbox) {
        const linkCard = checkbox.closest(".link-card");
        if (checkbox.checked) {
          selectedLinks.add(linkId);
          linkCard.classList.add("selected");
        } else {
          selectedLinks.delete(linkId);
          linkCard.classList.remove("selected");
        }
        updateBulkActionBar();
      }

      function updateBulkActionBar() {
        const count = selectedLinks.size;
        if (count > 0) {
          selectionCount.textContent = `${count} link dipilih`;
          bulkActionBar.classList.add("visible");
        } else {
          bulkActionBar.classList.remove("visible");
        }
      }

      function countLinksInFolders() {
        const counts = {};
        allFolders.forEach((folder) => {
          counts[folder.id] = 0;
        });
        allLinks.forEach((link) => {
          if (link.folderId && counts.hasOwnProperty(link.folderId)) {
            counts[link.folderId]++;
          }
        });
        return counts;
      }

      addTagForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const newTag = newTagInput.value.trim();
        if (newTag && currentEditingUserId) {
          const userRef = db.collection("users").doc(currentEditingUserId);
          try {
            await userRef.update({
              tags: firebase.firestore.FieldValue.arrayUnion(newTag),
            });
            const userDoc = await userRef.get();
            renderCurrentTags(userDoc.data().tags || []);
            newTagInput.value = "";
          } catch (error) {
            console.error("Error adding tag:", error);
            showMessage("Gagal menambah tag.", "error");
          }
        }
      });

      async function removeTag(tagToRemove) {
        if (!currentEditingUserId) return;
        const userRef = db.collection("users").doc(currentEditingUserId);
        try {
          await userRef.update({
            tags: firebase.firestore.FieldValue.arrayRemove(tagToRemove),
          });
          const userDoc = await userRef.get();
          renderCurrentTags(userDoc.data().tags || []);
        } catch (error) {
          console.error("Error removing tag:", error);
          showMessage("Gagal menghapus tag.", "error");
        }
      }

      async function editFolder(folderId, currentName) {
        // 1. Minta input nama baru dari pengguna, dengan nama lama sebagai nilai default
        const newName = prompt("Masukkan nama folder baru:", currentName);

        // 2. Lakukan validasi input
        if (
          newName &&
          newName.trim() !== "" &&
          newName.trim() !== currentName
        ) {
          try {
            // 3. Update nama folder di Firestore
            await db.collection("folders").doc(folderId).update({
              name: newName.trim(),
            });
            showMessage("Nama folder berhasil diperbarui!", "success");
            // UI akan diperbarui secara otomatis oleh listener realtime Firestore
          } catch (error) {
            console.error("Gagal memperbarui nama folder:", error);
            showMessage("Gagal memperbarui nama folder.", "error");
          }
        }
      }

      // --- FOLDER MANAGEMENT FUNCTIONS (NEW) ---
      function listenToFolders() {
        if (!currentUser) return;
        const folderQuery = db.collection("folders").orderBy("name", "asc");

        const folderListener = folderQuery.onSnapshot(
          (snapshot) => {
            allFolders = [];
            snapshot.forEach((doc) => {
              allFolders.push({ id: doc.id, ...doc.data() });
            });

            const totalFoldersBadge =
              document.getElementById("totalFoldersBadge");
            if (allFolders.length > 0) {
              totalFoldersBadge.textContent = allFolders.length;
              totalFoldersBadge.classList.add("visible");
            } else {
              totalFoldersBadge.classList.remove("visible");
            }

            const folderCounts = countLinksInFolders();

            updateActionFolderDropdowns(allFolders);
            renderFilters();

            if (isAdmin) {
              renderFolderList(allFolders, folderCounts);
            }
          },
          (error) => {
            console.error("Error listening to folders:", error);
          }
        );

        unsubscribes.push(folderListener);
      }

      function updateActionFolderDropdowns(folders) {
        const selects = [
          document.getElementById("linkFolder"),
          document.getElementById("editLinkFolder"),
          document.getElementById("bulkMoveFolderSelect"),
        ];

        selects.forEach((select) => {
          if (!select) return;
          const currentValue = select.value;
          let optionsHTML = '<option value="">Tidak ada folder</option>';
          folders.forEach((folder) => {
            optionsHTML += `<option value="${folder.id}">${escapeHtml(
              folder.name
            )}</option>`;
          });
          select.innerHTML = optionsHTML;
          if (folders.some((f) => f.id === currentValue)) {
            select.value = currentValue;
          }
        });
      }

      function renderFolderList(folders, counts) {
        if (!folderListContainer || !counts) return; // Pengaman tambahan
        if (folders.length === 0) {
          folderListContainer.innerHTML =
            "<p>Belum ada folder yang dibuat.</p>";
          return;
        }
        folderListContainer.innerHTML = folders
          .map(
            (folder) => `
    <div class="user-list-item">
        <div>
            <span style="font-weight: 500;">${escapeHtml(folder.name)}</span>
            <span style="color: var(--text-secondary); font-size: 13px; margin-left: 8px;">
                ${counts[folder.id] || 0} item
            </span>
        </div>
        <div class="link-actions">
            <button class="btn btn-warning" onclick="editFolder('${
              folder.id
            }', '${escapeHtml(
              folder.name
            )}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
            <button class="btn btn-danger" onclick="deleteFolder('${
              folder.id
            }', '${escapeHtml(
              folder.name
            )}')" style="padding: 6px 12px; font-size: 12px;">Hapus</button>
        </div>
    </div>
`
          )
          .join("");
      }

      addFolderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const folderName = newFolderInput.value.trim();
        if (folderName && isAdmin) {
          try {
            await db.collection("folders").add({
              name: folderName,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
            newFolderInput.value = "";
            showMessage("Folder berhasil dibuat!", "success");
          } catch (error) {
            console.error("Error adding folder:", error);
            showMessage("Gagal membuat folder.", "error");
          }
        }
      });

      async function deleteFolder(folderId, folderName) {
        if (
          !confirm(
            `Yakin ingin menghapus folder "${folderName}"? Semua link di dalamnya akan dipindahkan ke "Tidak ada folder".`
          )
        )
          return;

        try {
          const linksSnapshot = await db
            .collection("links")
            .where("folderId", "==", folderId)
            .get();
          const batch = db.batch();

          linksSnapshot.forEach((doc) => {
            const linkRef = db.collection("links").doc(doc.id);
            batch.update(linkRef, { folderId: null });
          });

          const folderRef = db.collection("folders").doc(folderId);
          batch.delete(folderRef);

          await batch.commit();
          showMessage(`Folder "${folderName}" berhasil dihapus.`, "success");
        } catch (error) {
          console.error("Error deleting folder:", error);
          showMessage("Gagal menghapus folder.", "error");
        }
      }

      // --- TUTORIAL CARD LOGIC ---
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("tutorialDismissed") === "true") {
          tutorialCard.style.display = "none";
        }
      });

      closeTutorialBtn.addEventListener("click", () => {
        tutorialCard.style.display = "none";
        localStorage.setItem("tutorialDismissed", "true");
      });

      // --- THEME SWITCH LOGIC ---
      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        if (theme === "dark") {
          fabSunIcon.classList.add("hidden");
          fabMoonIcon.classList.remove("hidden");
        } else {
          fabSunIcon.classList.remove("hidden");
          fabMoonIcon.classList.add("hidden");
        }
      }

      themeFab.addEventListener("click", () => {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        setTheme(currentTheme === "dark" ? "light" : "dark");
      });

      // Load theme from localStorage or system preference
      const savedTheme = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;

      if (savedTheme) {
        setTheme(savedTheme);
      } else if (systemPrefersDark) {
        setTheme("dark");
      } else {
        setTheme("light");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text || "";
        return div.innerHTML;
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(
          () => {
            showMessage("Link berhasil disalin!", "success");
          },
          () => {
            showMessage("Gagal menyalin link.", "error");
          }
        );
      }

      function showMessage(message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
            position: fixed; top: 20px; right: 20px; padding: 12px 20px;
            border-radius: 8px; color: white; font-weight: 500; z-index: 1001;
            background-color: ${
              type === "success"
                ? "var(--success-color)"
                : "var(--danger-color)"
            };
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease; transform: translateX(120%);`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        setTimeout(() => {
          messageDiv.style.transform = "translateX(0)";
        }, 10);
        setTimeout(() => {
          messageDiv.style.transform = "translateX(120%)";
          messageDiv.addEventListener("transitionend", () =>
            messageDiv.remove()
          );
        }, 3000);
      }

      window.updateUserStatus = updateUserStatus;
      window.deleteUser = deleteUser;
      window.openEditModal = openEditModal;
      window.copyToClipboard = copyToClipboard;
      window.deleteLink = deleteLink;
      window.openTagModal = openTagModal;
      window.removeTag = removeTag;
      window.deleteFolder = deleteFolder;
      window.editFolder = editFolder;
      window.togglePin = togglePin;
      window.toggleLinkSelection = toggleLinkSelection; // <-- TAMBAHKAN INI
      window.showQrCode = showQrCode;
      document
        .getElementById("exportActiveBtn")
        .addEventListener("click", () => {
          const activeUsers = completeUserList.filter(
            (user) => user.status === "approved"
          );
          exportUsersToCSV(activeUsers, "pengguna-aktif.csv");
        });

      document
        .getElementById("exportBlockedBtn")
        .addEventListener("click", () => {
          const blockedUsers = completeUserList.filter(
            (user) => user.status === "rejected"
          );
          exportUsersToCSV(blockedUsers, "pengguna-diblokir.csv");
        });
    </script>
  </body>
</html>
